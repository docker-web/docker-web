kind: pipeline
type: docker
name: default

steps:
  - name: deploy
    image: docker:dind
    volumes:
      - name: docker
        path: /var/run/docker.sock
      - name: pegaz
        path: /opt/pegaz
    environment:
      CI_JELLYFIN_API_KEY:
        from_secret: CI_JELLYFIN_API_KEY
    commands:
      - WORKDIR="/opt/pegaz/"
      - sed -i "s|JELLYFIN_API_KEY=.*|JELLYFIN_API_KEY=$CI_JELLYFIN_API_KEY|g" services/deluge/config.sh
      - bash cli.pegaz.sh upgrade

volumes:
  - name: pegaz
    host:
      path: /opt/pegaz
  - name: docker
    host:
      path: /var/run/docker.sock